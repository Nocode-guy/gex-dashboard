<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEX Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css?v=2.8">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="app">
        <!-- Sticky Header Wrapper -->
        <div class="sticky-header">
            <!-- Top Bar: Ticker Pills -->
            <div class="ticker-bar">
            <div class="ticker-bar-left">
                <div class="all-tickers-dropdown">
                    <button class="all-tickers-btn" id="btnAllTickers">
                        <span class="hamburger">‚ò∞</span>
                        All Tickers
                        <span class="ticker-count" id="symbolCount">0</span>
                    </button>
                    <div class="all-tickers-menu" id="allTickersMenu">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <div class="ticker-pills-container">
                <div class="ticker-pills" id="symbolTabs">
                    <!-- Ticker pills populated by JS -->
                </div>
            </div>
            <div class="ticker-bar-right">
                <div class="symbol-search">
                    <input type="text" id="symbolInput" placeholder="+ Add symbol" autocomplete="off">
                    <div class="search-dropdown" id="searchDropdown"></div>
                </div>
            </div>
        </div>

        <!-- Control Bar -->
        <div class="control-bar">
            <div class="control-left">
                <div class="metric-toggles">
                    <button class="btn-metric active" data-view="gex">‚ö° GEX</button>
                    <button class="btn-metric" data-view="vex">üìà VEX</button>
                    <button class="btn-metric" data-view="dex">Œî DEX</button>
                    <button class="btn-metric" data-view="flow">üìä Flow</button>
                    <button class="btn-metric" data-view="chart">üìà Chart</button>
                </div>
            </div>

            <div class="control-center">
                <button class="nav-arrow" id="btnPrevSymbol">‚Äπ</button>
                <div class="symbol-display">
                    <span class="symbol-badge" id="symbolName">SPX</span>
                    <span class="spot-price" id="spotPrice">$0.00</span>
                    <span class="price-change positive" id="priceChange">+0.00 (+0.00%)</span>
                </div>
                <button class="nav-arrow" id="btnNextSymbol">‚Ä∫</button>
            </div>

            <div class="control-right">
                <button class="btn-icon ai-btn" id="btnAI" title="AI Analysis">
                    ü§ñ
                </button>
                <button class="btn-icon alerts-btn" id="btnAlerts" title="Trading Alerts">
                    üîî
                    <span class="alert-badge" id="alertBadge" style="display: none;">0</span>
                </button>
                <button class="btn-icon" id="btnWallsToggle" title="GEX by Strike">üìä</button>
                <button class="btn-icon" id="btnCenterSpot" title="Center on Spot">‚óé</button>
                <button class="btn-icon" id="btnCenterKing" title="Center on King">üëë</button>
                <button class="btn-icon" id="btnThemeToggle" title="Theme">
                    <span id="themeIcon">‚òÄ</span>
                </button>
                <div class="user-menu-dropdown">
                    <button class="btn-icon" id="btnUserMenu" title="Account">üë§</button>
                    <div class="user-menu" id="userMenu">
                        <div class="user-menu-header" id="userEmail">Not signed in</div>
                        <a href="/admin" class="user-menu-item" id="adminLink" style="display:none;">Admin Dashboard</a>
                        <a href="/journal" class="user-menu-item">Trading Journal</a>
                        <button class="user-menu-item" id="btnChangePassword">Change Password</button>
                        <button class="user-menu-item" id="btnLogout">Logout</button>
                    </div>
                </div>
                <div class="interval-label">1m</div>
                <div class="live-indicator" id="liveIndicator">
                    <span class="live-dot"></span>
                    <span class="live-text">Live</span>
                    <span class="live-time" id="currentTime">--:--:--</span>
                </div>
                <button class="btn-replay" id="btnEnterPlayback" title="Replay historical data">
                    <span class="replay-icon">‚èÆ</span>
                </button>
                <button class="btn-help" id="btnCheatSheet" title="Trading Cheat Sheet">
                    <span class="help-icon">üìñ</span>
                </button>
            </div>
        </div>

        <!-- Replay Panel (dropdown, hidden by default) -->
        <div class="replay-panel" id="playbackBar" style="display: none;">
            <div class="replay-timeline-container">
                <span class="timeline-label">Open</span>
                <div class="replay-timeline">
                    <input type="range" id="playbackSlider" class="replay-slider" min="0" max="100" value="0">
                    <div class="timeline-markers">
                        <span class="marker" style="left: 0%">9:30</span>
                        <span class="marker" style="left: 50%">Noon</span>
                        <span class="marker" style="left: 100%">4:00</span>
                    </div>
                </div>
                <span class="timeline-label">Close</span>
            </div>
            <div class="replay-controls-row">
                <div class="replay-date-time">
                    <input type="date" id="playbackDatePicker" class="replay-date-input">
                    <input type="text" id="playbackTimeInput" class="replay-time-input" value="09:30:00" readonly>
                </div>
                <div class="replay-controls">
                    <button class="replay-btn" id="btnPlaybackPrev" title="Skip to start">‚èÆ</button>
                    <button class="replay-btn" id="btnPlaybackBack" title="Step back">‚óÄ</button>
                    <button class="replay-btn replay-play" id="btnPlaybackToggle" title="Play/Pause">‚ñ∂</button>
                    <button class="replay-btn" id="btnPlaybackForward" title="Step forward">‚ñ∂</button>
                    <button class="replay-btn" id="btnPlaybackNext" title="Skip to end">‚è≠</button>
                </div>
                <div class="replay-speed">
                    <select id="playbackSpeed" class="replay-speed-select">
                        <option value="0.5">0.5x</option>
                        <option value="1">1x</option>
                        <option value="2" selected>2x</option>
                        <option value="4">4x</option>
                    </select>
                </div>
                <div class="replay-snapshot">
                    <span class="snapshot-label">SNAPSHOT</span>
                    <span class="snapshot-time" id="playbackTime">--:--:-- AM</span>
                </div>
                <button class="btn-exit-replay" id="btnPlaybackExit">
                    <span class="exit-dot"></span>
                    Exit Replay
                </button>
            </div>
        </div>

        <!-- Metrics Bar -->
        <div class="metrics-bar">
            <div class="metric-item">
                <span class="metric-label">Net GEX</span>
                <span class="metric-value" id="netGex">$0.0B</span>
                <span class="metric-delta" id="deltaGexOpen">--</span>
            </div>
            <div class="metric-divider"></div>
            <div class="metric-item">
                <span class="metric-label">King</span>
                <span class="metric-value king" id="kingNode">--</span>
                <span class="metric-sub" id="kingGex">--</span>
            </div>
            <div class="metric-divider"></div>
            <div class="metric-item">
                <span class="metric-label">Zero Gamma</span>
                <span class="metric-value" id="zeroGamma">--</span>
                <span class="metric-sub" id="zeroGammaDistance">--</span>
            </div>
            <div class="metric-divider"></div>
            <div class="metric-item">
                <span class="metric-label">To King</span>
                <span class="metric-value" id="kingDistance">--</span>
            </div>
            <div class="metric-divider"></div>
            <!-- Dealer Status -->
            <div class="dealer-status" id="dealerStatus">
                <span class="dealer-label">Dealers:</span>
                <span class="dealer-action" id="dealerAction">--</span>
            </div>
            <div class="metric-divider"></div>
            <div class="pressure-gauge-mini">
                <span class="gauge-label">Gamma:</span>
                <div class="gauge-bar">
                    <div class="gauge-fill" id="pressureFill"></div>
                    <div class="gauge-marker" id="pressureMarker"></div>
                </div>
                <span class="gauge-text" id="pressureText">NEUTRAL</span>
            </div>
        </div>

            <!-- Dealer Flip Warning Banner (hidden by default) -->
            <div class="dealer-warning" id="dealerWarning" style="display: none;">
                <span class="warning-icon">‚ö†Ô∏è</span>
                <span class="warning-text" id="dealerWarningText">Dealer Flip Risk</span>
            </div>
        </div><!-- End Sticky Header -->

        <!-- Main Content -->
        <main class="main-content">
            <!-- OPEX Warning Banner -->
            <div class="opex-warning" id="opexWarning" style="display: none;">
                <span class="warning-icon">‚ö†Ô∏è</span>
                <span>OPEX Week - Near-term nodes may be less reliable</span>
            </div>

            <!-- Heatmap -->
            <div class="heatmap-container">
                <div class="heatmap-wrapper">
                    <table class="heatmap" id="heatmapTable">
                        <thead>
                            <tr id="heatmapHeader">
                                <th class="strike-col">Strike</th>
                            </tr>
                        </thead>
                        <tbody id="heatmapBody"></tbody>
                    </table>
                </div>

                <!-- Key Zones Sidebar -->
                <aside class="zones-sidebar">
                    <h3>Key Zones</h3>
                    <div class="zones-list" id="zonesList"></div>
                </aside>
            </div>

            <!-- Chart Container (Price Candlestick with GEX Levels) -->
            <div class="chart-container" id="chartContainer" style="display: none;">
                <div class="chart-header">
                    <div class="chart-title">
                        <h2>Price Chart</h2>
                        <span class="live-badge"><span class="pulse-dot"></span> LIVE</span>
                    </div>
                    <!-- Chart Mode Tabs -->
                    <div class="chart-mode-tabs">
                        <button class="chart-mode-btn active" data-mode="basic">Basic</button>
                        <button class="chart-mode-btn" data-mode="heatmap">Heatmap</button>
                        <span class="tab-divider"></span>
                        <button class="chart-mode-btn volume-toggle" id="volumeToggle" data-mode="volume">Volume</button>
                        <button class="heatmap-info-btn" id="heatmapInfoBtn" title="How to read the heatmap">?</button>
                    </div>

                    <!-- Heatmap Info Popup -->
                    <div class="heatmap-info-popup" id="heatmapInfoPopup">
                        <div class="heatmap-info-content">
                            <button class="heatmap-info-close" id="heatmapInfoClose">&times;</button>
                            <h3>GEX Heatmap Guide</h3>
                            <div class="heatmap-color-legend">
                                <p style="margin-bottom: 8px; color: var(--text-secondary);"><strong>Support Zones (Positive GEX):</strong></p>
                                <div class="legend-row">
                                    <span class="color-box light-blue"></span>
                                    <span><strong>Light Blue</strong> - Weak Support</span>
                                </div>
                                <div class="legend-row">
                                    <span class="color-box dark-blue"></span>
                                    <span><strong>Dark Blue</strong> - Strong Support</span>
                                </div>
                                <p style="margin: 12px 0 8px 0; color: var(--text-secondary);"><strong>Acceleration Zones (Negative GEX):</strong></p>
                                <div class="legend-row">
                                    <span class="color-box yellow"></span>
                                    <span><strong>Yellow</strong> - Weak Acceleration</span>
                                </div>
                                <div class="legend-row">
                                    <span class="color-box orange"></span>
                                    <span><strong>Gold</strong> - Strong Acceleration</span>
                                </div>
                            </div>
                            <p style="margin: 12px 0 8px 0; color: var(--text-secondary);"><strong>Liquidity Zones:</strong></p>
                            <div class="legend-row">
                                <span class="color-box white"></span>
                                <span><strong>White Pulsing Lines</strong> - High Open Interest / Volume</span>
                            </div>
                            <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Thicker line = higher liquidity. Faster pulse = more activity.</p>

                            <div class="heatmap-info-text" style="margin-top: 12px;">
                                <p><strong>Blue Zones (Support):</strong><br>
                                Price tends to slow down and consolidate. Market makers stabilize price.</p>
                                <p><strong>Yellow/Gold Zones (Acceleration):</strong><br>
                                Price moves quickly. Market makers amplify moves, creating breakouts.</p>
                                <p><strong>Trading Tips:</strong></p>
                                <ul>
                                    <li>Price approaching blue = expect reversal</li>
                                    <li>Price entering yellow/gold = expect breakout</li>
                                    <li>Darker blue = stronger support</li>
                                    <li>More gold = stronger acceleration</li>
                                    <li>White lines = key liquidity levels to watch</li>
                                </ul>
                            </div>

                            <p style="margin: 16px 0 8px 0; color: var(--text-secondary); border-top: 1px solid var(--border-color); padding-top: 12px;"><strong>Volume Panel (Real-Time):</strong></p>
                            <div class="heatmap-color-legend">
                                <div class="legend-row">
                                    <span class="color-box" style="background: #22c55e;"></span>
                                    <span><strong>Green Bar</strong> - Call Premium at strike</span>
                                </div>
                                <div class="legend-row">
                                    <span class="color-box" style="background: #ef4444;"></span>
                                    <span><strong>Red Bar</strong> - Put Premium at strike</span>
                                </div>
                                <div class="legend-row">
                                    <span style="color: #22c55e; font-weight: 600; width: 20px;">+%</span>
                                    <span><strong>Green %</strong> - Calls winning at strike</span>
                                </div>
                                <div class="legend-row">
                                    <span style="color: #ef4444; font-weight: 600; width: 20px;">-%</span>
                                    <span><strong>Red %</strong> - Puts winning at strike</span>
                                </div>
                            </div>
                            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                                Data updates every 5 seconds from Unusual Whales.<br>
                                +100% = all calls, -100% = all puts, 0% = equal.
                            </p>
                        </div>
                    </div>
                    <div class="chart-timeframe">
                        <button class="chart-tf-btn active" data-resolution="1">1m</button>
                        <button class="chart-tf-btn" data-resolution="5">5m</button>
                        <button class="chart-tf-btn" data-resolution="15">15m</button>
                        <button class="chart-tf-btn" data-resolution="60">1h</button>
                        <button class="chart-tf-btn" data-resolution="D">D</button>
                    </div>
                </div>
                <div class="chart-split-container" id="chartSplitContainer">
                    <div class="price-chart-wrapper">
                        <canvas id="gexHeatmapCanvas" class="heatmap-canvas"></canvas>
                        <div class="price-chart" id="priceChart">
                            <div class="chart-loading">Loading chart...</div>
                        </div>
                    </div>
                    <!-- Volume by Strike Panel (toggle overlay) -->
                    <div class="volume-panel" id="volumePanel" style="display: none;">
                        <div class="volume-bars-container" id="volumeBarsContainer">
                            <div class="volume-loading">Loading volume...</div>
                        </div>
                    </div>
                </div>
                <div class="chart-legend">
                    <span class="legend-item"><span class="legend-line magnet"></span> Magnet</span>
                    <span class="legend-item"><span class="legend-line resistance"></span> Resistance</span>
                    <span class="legend-item"><span class="legend-line support"></span> Support</span>
                    <span class="legend-item"><span class="legend-line accel"></span> Accelerator</span>
                    <span class="legend-item"><span class="legend-line zero-gamma"></span> 0Œ≥ Flip</span>
                </div>
            </div>

            <!-- Flow Container -->
            <div class="flow-container" id="flowContainer" style="display: none;">
                <!-- Top Flow Ticker (Horizontal Scrolling) - Top Moving Stocks -->
                <div class="flow-ticker-container" id="flowTickerContainer">
                    <div class="flow-ticker-label">
                        <span class="ticker-title">TOP FLOW</span>
                        <span class="live-badge tiny"><span class="pulse-dot"></span></span>
                    </div>
                    <div class="flow-ticker-track">
                        <div class="flow-ticker-content" id="flowTickerContent">
                            <span class="ticker-loading">Loading top flow...</span>
                        </div>
                    </div>
                    <button class="flow-ticker-expand" id="btnExpandTicker" title="Expand Leaderboard">
                        <span>‚§¢</span>
                    </button>
                </div>

                <!-- Flow Header -->
                <div class="flow-page-header">
                    <div class="flow-title">
                        <h2>Options Flow</h2>
                        <span class="live-badge"><span class="pulse-dot"></span> LIVE</span>
                    </div>
                    <div class="flow-sentiment-badge" id="flowSentimentBadge">
                        <span class="sentiment-icon">üìä</span>
                        <span>Flow: </span>
                        <span class="sentiment-value" id="flowSentimentValue">NEUTRAL</span>
                        <span class="sentiment-pct" id="flowPressureValue">0%</span>
                    </div>
                </div>

                <!-- Metrics Row -->
                <div class="flow-metrics-row">
                    <div class="flow-metric-card call">
                        <div class="metric-header">
                            <span class="metric-label">Call Premium</span>
                            <span class="metric-icon">üìà</span>
                        </div>
                        <div class="metric-value" id="flowCallPremium">$0</div>
                    </div>
                    <div class="flow-metric-card put">
                        <div class="metric-header">
                            <span class="metric-label">Put Premium</span>
                            <span class="metric-icon">üìâ</span>
                        </div>
                        <div class="metric-value" id="flowPutPremium">$0</div>
                    </div>
                    <div class="flow-metric-card net">
                        <div class="metric-header">
                            <span class="metric-label">Net Premium</span>
                            <span class="metric-icon">‚ö°</span>
                        </div>
                        <div class="metric-value" id="flowNetPremium">$0</div>
                    </div>
                    <div class="flow-metric-card sweeps">
                        <div class="metric-header">
                            <span class="metric-label">Sweeps</span>
                            <span class="metric-icon">üî•</span>
                        </div>
                        <div class="metric-value" id="flowSweeps">0 / 0</div>
                    </div>
                    <div class="flow-metric-card blocks">
                        <div class="metric-header">
                            <span class="metric-label">Blocks</span>
                            <span class="metric-icon">üì¶</span>
                        </div>
                        <div class="metric-value" id="flowBlocks">0 / 0</div>
                    </div>
                    <div class="flow-metric-card velocity">
                        <div class="metric-header">
                            <span class="metric-label">1m Velocity</span>
                            <span class="metric-icon">‚è±</span>
                        </div>
                        <div class="metric-value" id="flowVelocity">$0</div>
                    </div>
                </div>

                <!-- Rate of Change Bar -->
                <div class="flow-roc-bar">
                    <div class="roc-label">
                        <span class="roc-icon">‚è±</span>
                        <span>Rate of Change</span>
                    </div>
                    <div class="roc-items">
                        <div class="roc-item">
                            <span class="roc-period">1 min</span>
                            <span class="roc-value positive" id="roc1m">+$0</span>
                        </div>
                        <div class="roc-item">
                            <span class="roc-period">5 min</span>
                            <span class="roc-value positive" id="roc5m">+$0</span>
                        </div>
                        <div class="roc-item">
                            <span class="roc-period">10 min</span>
                            <span class="roc-value positive" id="roc10m">+$0</span>
                        </div>
                    </div>
                </div>

                <!-- Flow Content -->
                <div class="flow-content">
                    <!-- WAVE Indicator Panel -->
                    <div class="flow-panel wave-panel full-width" id="panelWave">
                        <div class="wave-header">
                            <div class="wave-title-row">
                                <h3>WAVE Indicator</h3>
                                <span class="live-badge small"><span class="pulse-dot"></span> LIVE</span>
                            </div>
                            <div class="wave-legend">
                                <span class="legend-item"><span class="legend-line call"></span> Call Flow</span>
                                <span class="legend-item"><span class="legend-line put"></span> Put Flow</span>
                                <span class="legend-item"><span class="legend-line wave"></span> Net WAVE</span>
                            </div>
                            <div class="wave-timeframe">
                                <button class="wave-tf-btn active" data-minutes="15">15m</button>
                                <button class="wave-tf-btn" data-minutes="60">1h</button>
                                <button class="wave-tf-btn" data-minutes="240">4h</button>
                            </div>
                        </div>
                        <div class="wave-chart" id="waveChart">
                            <div class="wave-loading">Loading WAVE data...</div>
                        </div>
                        <div class="wave-current">
                            <div class="wave-stat">
                                <span class="wave-label">Current WAVE</span>
                                <span class="wave-value" id="waveValue">$0</span>
                            </div>
                            <div class="wave-stat">
                                <span class="wave-label">Call Flow</span>
                                <span class="wave-value call" id="waveCallValue">$0</span>
                            </div>
                            <div class="wave-stat">
                                <span class="wave-label">Put Flow</span>
                                <span class="wave-value put" id="wavePutValue">$0</span>
                            </div>
                            <div class="wave-stat">
                                <span class="wave-label">Direction</span>
                                <span class="wave-direction" id="waveDirection">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Trade Tape Panel - Hidden until real trade data is available
                    <div class="flow-panel tape-panel full-width" id="panelTape">
                        ...
                    </div>
                    -->

                    <!-- Strike Distribution Panel (Full Width) -->
                    <div class="flow-panel distribution-panel full-width" id="panelDistribution">
                        <div class="distribution-header">
                            <h3>Volume by Strike <span class="spot-indicator" id="flowSpotIndicator"></span></h3>
                            <div class="distribution-legend">
                                <span class="legend-item"><span class="legend-dot call"></span> Call Volume</span>
                                <span class="legend-item"><span class="legend-dot put"></span> Put Volume</span>
                            </div>
                        </div>
                        <div class="flow-pressure-bars" id="flowPressureBars">
                            <div class="flow-loading">Loading flow data...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Status Bar (minimal footer) -->
        <div class="status-bar">
            <span class="status-item" id="connectionStatus">Connected</span>
            <span class="status-item">Data: <span id="dataSource">--</span></span>
            <span class="status-item" id="lastUpdate">Updated: --:--:--</span>
        </div>

        <!-- Hidden elements for compatibility -->
        <div style="display:none;">
            <span id="currentDate"></span>
            <span id="regimeVix"></span>
            <span id="regimeBadge"></span>
            <span id="reliabilityBadge"></span>
            <span id="eventBadge"></span>
            <span id="marketStatusBadge"></span>
            <span id="deltaGex"></span>
            <span id="deltaVex"></span>
            <span id="deltaDex"></span>
            <span id="alertsIndicator"></span>
            <span id="alertCount"></span>
            <span id="heatmapViewTitle"></span>
            <span id="playbackStart"></span>
            <span id="playbackEnd"></span>
        </div>

        <!-- Top Flow Leaderboard Popup -->
        <div class="leaderboard-overlay" id="leaderboardOverlay" style="display: none;">
            <div class="leaderboard-popup">
                <div class="leaderboard-popup-header">
                    <h3>Top Flow Leaderboard</h3>
                    <div class="leaderboard-popup-controls">
                        <div class="leaderboard-sort">
                            <button class="leaderboard-sort-btn active" data-sort="total">Volume</button>
                            <button class="leaderboard-sort-btn" data-sort="wave">WAVE %</button>
                        </div>
                        <button class="btn-close-leaderboard" id="btnCloseLeaderboard">&times;</button>
                    </div>
                </div>
                <div class="leaderboard-popup-list" id="leaderboardPopupList">
                    <!-- Rendered by JS -->
                </div>
            </div>
        </div>

        <!-- GEX by Strike Popup -->
        <div class="walls-overlay" id="wallsOverlay" style="display: none;">
            <div class="walls-popup">
                <div class="walls-header">
                    <h3>GEX by Strike</h3>
                    <button class="btn-close-walls" id="btnCloseWalls">&times;</button>
                </div>
                <div class="walls-chart" id="wallsChart">
                    <!-- Rendered by JS -->
                </div>
                <div class="walls-legend">
                    <span class="legend-item"><span class="legend-color call"></span> Call GEX</span>
                    <span class="legend-item"><span class="legend-color put"></span> Put GEX</span>
                </div>
            </div>
        </div>

        <!-- Trading Alerts Panel -->
        <div class="alerts-overlay" id="alertsOverlay" style="display: none;">
            <div class="alerts-panel">
                <div class="alerts-header">
                    <h3>üîî Trading Alerts</h3>
                    <div class="alerts-controls">
                        <button class="btn-clear-alerts" id="btnClearAlerts" title="Clear all">Clear</button>
                        <button class="btn-close-alerts" id="btnCloseAlerts">&times;</button>
                    </div>
                </div>
                <div class="alerts-status">
                    <span class="alerts-monitoring">Monitoring <span id="alertSymbolCount">30</span> symbols</span>
                    <span class="alerts-refresh">Updates every 30s</span>
                </div>
                <div class="alerts-list" id="alertsList">
                    <div class="alerts-empty">No alerts yet. Watching for opportunities...</div>
                </div>
            </div>
        </div>

        <!-- AI Analysis Panel -->
        <div class="ai-overlay" id="aiOverlay" style="display: none;">
            <div class="ai-panel">
                <div class="ai-header">
                    <h3>ü§ñ AI Trading Analysis</h3>
                    <div class="ai-controls">
                        <button class="btn-analyze" id="btnAnalyze" title="Get full analysis">Analyze</button>
                        <button class="btn-close-ai" id="btnCloseAI">&times;</button>
                    </div>
                </div>
                <div class="ai-symbol-info">
                    <span class="ai-symbol" id="aiSymbol">SPY</span>
                    <span class="ai-status" id="aiStatus">Ready</span>
                </div>
                <div class="ai-messages" id="aiMessages">
                    <div class="ai-welcome">
                        <p>Ask me about the current setup, levels, or trading scenarios.</p>
                        <p>Or click <strong>Analyze</strong> for a full trading read.</p>
                    </div>
                </div>
                <div class="ai-input-container">
                    <input type="text" class="ai-input" id="aiInput" placeholder="Ask about this trade..." />
                    <button class="btn-send-ai" id="btnSendAI">‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Cheat Sheet Slide-out Panel -->
        <div class="cheatsheet-overlay" id="cheatsheetOverlay">
            <div class="cheatsheet-panel" id="cheatsheetPanel">
                <div class="cheatsheet-header">
                    <h2>üìñ Trading Cheat Sheet</h2>
                    <button class="btn-close-cheatsheet" id="btnCloseCheatsheet">&times;</button>
                </div>
                <div class="cheatsheet-content">
                    <!-- GEX Basics -->
                    <div class="cheat-section">
                        <h3>‚ö° GEX Basics</h3>
                        <div class="cheat-card positive">
                            <span class="cheat-label">Positive GEX</span>
                            <span class="cheat-meaning">Mean reversion mode</span>
                            <span class="cheat-action">Fade extremes, buy dips, sell rips</span>
                        </div>
                        <div class="cheat-card negative">
                            <span class="cheat-label">Negative GEX</span>
                            <span class="cheat-meaning">Trending/volatile mode</span>
                            <span class="cheat-action">Follow momentum, don't fade</span>
                        </div>
                    </div>

                    <!-- Key Levels -->
                    <div class="cheat-section">
                        <h3>üìç Key Levels</h3>
                        <div class="cheat-card king">
                            <span class="cheat-label">üëë KING</span>
                            <span class="cheat-meaning">Highest absolute GEX ‚Äî strongest magnet</span>
                            <span class="cheat-action">Price gravitates here. Trade toward it.</span>
                        </div>
                        <div class="cheat-card zero-gamma">
                            <span class="cheat-label">‚öñÔ∏è ZERO GAMMA</span>
                            <span class="cheat-meaning">Dealer flip point ‚Äî regime change</span>
                            <span class="cheat-action">Above = stable | Below = volatile</span>
                        </div>
                        <div class="cheat-card magnet">
                            <span class="cheat-label">üß≤ MAGNET</span>
                            <span class="cheat-meaning">High positive GEX ‚Äî price target</span>
                            <span class="cheat-action">Expect price to drift toward this level</span>
                        </div>
                        <div class="cheat-card gatekeeper">
                            <span class="cheat-label">üöß GATEKEEPER</span>
                            <span class="cheat-meaning">Must break for trend continuation</span>
                            <span class="cheat-action">Rejection = reversal | Break = acceleration</span>
                        </div>
                        <div class="cheat-card accelerator">
                            <span class="cheat-label">üî• ACCELERATOR</span>
                            <span class="cheat-meaning">High negative GEX ‚Äî vol expansion</span>
                            <span class="cheat-action">If price enters ‚Üí fast move, don't fight it</span>
                        </div>
                    </div>

                    <!-- Dealer Status -->
                    <div class="cheat-section">
                        <h3>üè¶ Dealer Status</h3>
                        <div class="cheat-card buying">
                            <span class="cheat-label">Buying Dips</span>
                            <span class="cheat-meaning">Dealers short delta ‚Äî they buy weakness</span>
                            <span class="cheat-action">Bullish. Dips get bought. Look for longs.</span>
                        </div>
                        <div class="cheat-card selling">
                            <span class="cheat-label">Selling Rallies</span>
                            <span class="cheat-meaning">Dealers long delta ‚Äî they sell strength</span>
                            <span class="cheat-action">Range / Controlled. Rallies capped. Fade unless GEX flips or King breaks.</span>
                        </div>
                    </div>

                    <!-- Quick Plays -->
                    <div class="cheat-section">
                        <h3>üéØ Quick Plays</h3>
                        <div class="cheat-play">
                            <span class="play-setup">Price at King + Positive GEX</span>
                            <span class="play-action">‚Üí Expect chop/consolidation. Range trade.</span>
                        </div>
                        <div class="cheat-play">
                            <span class="play-setup">Price breaks below Zero Gamma</span>
                            <span class="play-action">‚Üí Volatility incoming. Trail stops, ride trend.</span>
                        </div>
                        <div class="cheat-play">
                            <span class="play-setup">Price near Magnet + "Buying Dips"</span>
                            <span class="play-action">‚Üí Strong support. Buy the dip with tight stop.</span>
                        </div>
                        <div class="cheat-play">
                            <span class="play-setup">Dealer Flip Warning showing</span>
                            <span class="play-action">‚Üí Caution! Regime change possible. Reduce size.</span>
                        </div>
                        <div class="cheat-play">
                            <span class="play-setup">Price enters Accelerator zone</span>
                            <span class="play-action">‚Üí Don't fade! Go with momentum or stay flat. Failed entry = snapback.</span>
                        </div>
                    </div>

                    <!-- Regime Strength -->
                    <div class="cheat-section">
                        <h3>üß† Regime Strength</h3>
                        <div class="cheat-card positive">
                            <span class="cheat-label">High Positive GEX</span>
                            <span class="cheat-meaning">Strong pin ‚Äî levels will hold</span>
                            <span class="cheat-action">Trade the range confidently. Mean reversion works.</span>
                        </div>
                        <div class="cheat-card neutral">
                            <span class="cheat-label">Weak Positive GEX</span>
                            <span class="cheat-meaning">Pin fragile ‚Äî can break with volume</span>
                            <span class="cheat-action">Tighter stops. Watch for breakout signals.</span>
                        </div>
                        <div class="cheat-card negative">
                            <span class="cheat-label">Rapid GEX Decay</span>
                            <span class="cheat-meaning">Support weakening ‚Äî breakdown likely</span>
                            <span class="cheat-action">Don't buy dips. Wait for new floor to form.</span>
                        </div>
                    </div>

                    <!-- Warning Signs -->
                    <div class="cheat-section">
                        <h3>‚ö†Ô∏è Warning Signs</h3>
                        <div class="cheat-warning">
                            <span class="warning-trigger">FLIP ZONE</span>
                            <span class="warning-meaning">Price at Zero Gamma ‚Äî could flip regime</span>
                        </div>
                        <div class="cheat-warning">
                            <span class="warning-trigger">Dealer Delta Flip</span>
                            <span class="warning-meaning">Dealers reversed positioning ‚Äî momentum shift</span>
                        </div>
                        <div class="cheat-warning">
                            <span class="warning-trigger">Œî GEX dropping fast</span>
                            <span class="warning-meaning">Support weakening ‚Äî be ready for breakdown</span>
                        </div>
                    </div>

                    <!-- Color Guide -->
                    <div class="cheat-section">
                        <h3>üé® Color Guide</h3>
                        <div class="color-guide">
                            <div class="color-item"><span class="color-dot green"></span> Green = Support / Bullish</div>
                            <div class="color-item"><span class="color-dot red"></span> Red = Resistance / Acceleration</div>
                            <div class="color-item"><span class="color-dot yellow"></span> Yellow = King / Magnet (key level)</div>
                            <div class="color-item"><span class="color-dot blue"></span> Blue = Neutral / Info</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-overlay" id="changePasswordModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="modal-close" id="closePasswordModal">&times;</button>
            </div>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" required minlength="8">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" required>
                    </div>
                    <div class="modal-error" id="passwordError" style="display:none;"></div>
                    <div class="modal-success" id="passwordSuccess" style="display:none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" id="cancelPasswordChange">Cancel</button>
                    <button type="submit" class="btn-save">Save Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- What's New Popup -->
    <div class="whats-new-overlay" id="whatsNewOverlay">
        <div class="whats-new-modal">
            <div class="whats-new-header">
                <h2>üéâ What's New in GEX Dashboard</h2>
                <button class="whats-new-close" id="closeWhatsNew">&times;</button>
            </div>
            <div class="whats-new-content">
                <div class="whats-new-item">
                    <span class="whats-new-icon">ü§ñ</span>
                    <div>
                        <h3>AI-Powered Analysis</h3>
                        <p>Get instant AI insights on any symbol. Chat with our AI about market conditions, GEX levels, and trading strategies.</p>
                    </div>
                </div>
                <div class="whats-new-item">
                    <span class="whats-new-icon">üìì</span>
                    <div>
                        <h3>Trading Journal</h3>
                        <p>Track your trades with our new journal. View P&L calendar, analytics, win rate, and equity curves. Import trades via CSV.</p>
                    </div>
                </div>
                <div class="whats-new-item">
                    <span class="whats-new-icon">üìä</span>
                    <div>
                        <h3>Enhanced Chart Signals</h3>
                        <p>New technical indicators and signals overlaid on charts. See support/resistance levels from GEX data.</p>
                    </div>
                </div>
                <div class="whats-new-item">
                    <span class="whats-new-icon">üîî</span>
                    <div>
                        <h3>Smart Alerts</h3>
                        <p>Real-time alerts for big movers, unusual options flow, and GEX level breaches.</p>
                    </div>
                </div>
                <div class="whats-new-item">
                    <span class="whats-new-icon">‚ö°</span>
                    <div>
                        <h3>Real-Time OPRA Data</h3>
                        <p>Live options data from OPRA feed via Massive/Polygon. Sub-second updates during market hours.</p>
                    </div>
                </div>
            </div>
            <div class="whats-new-footer">
                <label class="whats-new-checkbox">
                    <input type="checkbox" id="dontShowAgain" checked>
                    Don't show this again
                </label>
                <button class="btn-primary" id="btnGotIt">Got It!</button>
            </div>
        </div>
    </div>

    <style>
        .whats-new-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .whats-new-overlay.show {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .whats-new-modal {
            background: var(--card-bg, #1a1a2e);
            border-radius: 16px;
            width: 90%;
            max-width: 550px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .whats-new-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color, #333);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .whats-new-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--text-primary, #fff);
        }
        .whats-new-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-secondary, #888);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .whats-new-close:hover {
            color: var(--text-primary, #fff);
        }
        .whats-new-content {
            padding: 20px 24px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .whats-new-item {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color, #333);
        }
        .whats-new-item:last-child {
            border-bottom: none;
        }
        .whats-new-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        .whats-new-item h3 {
            margin: 0 0 6px 0;
            font-size: 16px;
            color: var(--text-primary, #fff);
        }
        .whats-new-item p {
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary, #aaa);
            line-height: 1.5;
        }
        .whats-new-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color, #333);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .whats-new-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary, #aaa);
            cursor: pointer;
        }
        .whats-new-checkbox input {
            width: 16px;
            height: 16px;
        }
        .whats-new-footer .btn-primary {
            padding: 10px 24px;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .whats-new-footer .btn-primary:hover {
            background: #0052cc;
        }
    </style>

    <script>
        // What's New Popup - Show once per user
        (function() {
            const WHATS_NEW_VERSION = '2026.01';
            const storageKey = 'gex_whats_new_seen_' + WHATS_NEW_VERSION;

            function showWhatsNew() {
                const seen = localStorage.getItem(storageKey);
                if (!seen) {
                    document.getElementById('whatsNewOverlay').classList.add('show');
                }
            }

            function closeWhatsNew() {
                const dontShow = document.getElementById('dontShowAgain').checked;
                if (dontShow) {
                    localStorage.setItem(storageKey, 'true');
                }
                document.getElementById('whatsNewOverlay').classList.remove('show');
            }

            document.getElementById('closeWhatsNew').addEventListener('click', closeWhatsNew);
            document.getElementById('btnGotIt').addEventListener('click', closeWhatsNew);
            document.getElementById('whatsNewOverlay').addEventListener('click', function(e) {
                if (e.target === this) closeWhatsNew();
            });

            // Show after page loads and user is logged in
            window.addEventListener('load', function() {
                setTimeout(showWhatsNew, 1000);
            });
        })();
    </script>

    <script src="/static/heatmap.js?v=2.8"></script>
</body>
</html>
